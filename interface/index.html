<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Demo</title>

		<style type="text/css">
			html, body {
				background-color: #282828;
				margin: 0;
				padding: 0;
			}
		</style>
	</head>
	<body>
		<style type="text/css">
			.map-viewport {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
				-webkit-user-select: none;
				user-select: none;
			}

			.map-viewport .map-whole {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}

			.map-whole .x-axis,
			.map-whole .y-axis {
				position: absolute;
				border: 2px dashed #444;
				font-size: 0;
			}

			.map-whole .x-axis {
				top: calc(50% - 1px);
				left: 0;
				width: 100%;
				height: 0;
			}

			.map-whole .y-axis {
				top: 0;
				left: calc(50% - 1px);
				width: 0;
				height: 100%;
			}

			.map-viewport .point {
				position: absolute;
				width: 10px;
				height: 10px;
				border-radius: 5px;
				background-color: #e5e5e5;
			}

			.map-viewport .inactive {
				opacity: 0.5;;
			}

			.map-viewport .hidden {
				display: none;
			}

			.map-viewport .ring {
				position: absolute;
				border-radius: 100%;
				border: 4px dotted #e5e5e5;
			}
		</style>
		<main class="map-viewport">
			<div id="Map" class="map-whole">
				<div class="x-axis"></div>
				<div class="y-axis"></div>
			</div>
		</main>
		<script type="text/javascript">
			// (function(){
				var map_width  = 1;
				var map_height = 1;

				var viewport_scale_x  = 10.0;
				var viewport_scale_y  = 10.0;
				var viewport_offset_x = 0;
				var viewport_offset_y = 0;

				var viewport_padding_x = 20;
				var viewport_padding_y = 20;

				// var viewport_width  = 1;
				// var viewport_height = 1;
				// var viewport_x      = 0;
				// var viewport_y      = 0;

				// var actual_x        = 0;
				// var actual_y        = 0;

				var estimated_x     = 0;
				var estimated_y     = 0;

				function Anchor(id, x, y) {
					this.id = id;
					this.x  = x;
					this.y  = y;

					this.radius = null;

					this.element = document.createElement('div');
					this.element.classList.add("point");

					this.circle_element = document.createElement("div");
					this.circle_element.classList.add("ring");

					this.is_active = true;

					this.update_element();
				}

				Anchor.prototype.update_element = function() {
					if (this.is_active) {
						this.element.classList.remove("inactive");
						this.circle_element.classList.remove("inactive");
					} else {
						this.element.classList.add("inactive");
						this.circle_element.classList.add("inactive");
						return;
					}

					var bound_box = this.element.getBoundingClientRect();

					this.element.style.left = ((this.x * viewport_scale_x) - bound_box.width / 2) + "px";
					this.element.style.bottom = ((this.y * viewport_scale_y) - bound_box.height / 2) + "px";

					if (this.radius == null) {
						this.circle_element.classList.add("hidden");
						return;
					}

					this.circle_element.classList.remove("hidden");

					this.circle_element.style.width = (2 * this.radius * viewport_scale_x) + "px";
					this.circle_element.style.height = (2 * this.radius * viewport_scale_y) + "px";

					var circle_box = this.circle_element.getBoundingClientRect();

					this.circle_element.style.left = ((this.x * viewport_scale_x) - circle_box.width / 2) + "px";
					this.circle_element.style.bottom = ((this.y * viewport_scale_y) - circle_box.height / 2) + "px";
				};

				Anchor.prototype.set_coord = function(x, y) {
					this.x = x;
					this.y = y;
				};

				Anchor.prototype.set_radius = function(x, y) {
					this.radius = x;
				};

				Anchor.prototype.insert_point = function(to_insert_into) {
					to_insert_into.appendChild(this.element);
					to_insert_into.appendChild(this.circle_element);
					this.update_element();
				};

				function Point(id, x, y) {
					this.id = id;
					this.x  = x;
					this.y  = y;

					this.element = document.createElement('div');
					this.element.classList.add("point");

					this.is_active = true;
				}

				Point.prototype.update_element = function() {
					if (this.is_active) {
						this.element.classList.remove("inactive");
					} else {
						this.element.classList.add("inactive");
						return;
					}

					var bound_box = this.element.getBoundingClientRect();

					this.element.style.left = (this.x * viewport_scale_x - bound_box.width / 2) + "px";
					this.element.style.bottom = (this.y * viewport_scale_y - bound_box.height / 2) + "px";
				};

				Point.prototype.set_coord = function(x, y) {
					this.x = x;
					this.y = y;
				};

				Point.prototype.insert_point = function(to_insert_into) {
					to_insert_into.appendChild(this.element);
					this.update_element();
				};

				var anchors = {};

				var points = {
					0: new Point(0, 25, 12)
				};

				function paint_elements() {
					for (var anchor_key in anchors) {
						document.getElementById("Map").appendChild(anchors[anchor_key].element);
					}

					for (var point_key in points) {
						document.getElementById("Map").appendChild(points[point_key].element);
					}
				}

				function parse_updates(json_update) {
					// upd_obj = JSON.parse(json_update);
					upd_obj = json_update;

					for (let antenna_id in anchors) {
						anchors[antenna_id].is_active = false;
					}

					for (let antenna_id in upd_obj.antennas) {
						let updated_info = upd_obj.antennas[antenna_id];

						if (anchors.hasOwnProperty(antenna_id)) {
							anchors[antenna_id].set_coord(updated_info.x, updated_info.y);
							anchors[antenna_id].set_radius(updated_info.r);
							anchors[antenna_id].is_active = true;
							anchors[antenna_id].update_element();
							return;
						}

						anchors[antenna_id] = new Anchor(antenna_id, updated_info.x, updated_info.y);
						anchors[antenna_id].set_radius(updated_info.r);
						anchors[antenna_id].insert_point(document.getElementById("Map"));
					}

					for (let point_id in points) {
						points[point_id].is_active = false;
					}

					for (let point_id in upd_obj.estimated_sources) {
						let updated_info = upd_obj.estimated_sources[point_id];

						if (points.hasOwnProperty(point_id)) {
							points[point_id].set_coord(updated_info.x, updated_info.y);
							points[point_id].is_active = true;
							points[point_id].update_element();
							return;
						}

						points[point_id] = new Point(point_id, updated_info.x, updated_info.y);
						points[point_id].insert_point(document.getElementById("Map"));
					}
				}
				// window.parse_updates = parse_updates;

				function get_updates() {
					fetch("upd.json").then(x => x.json()).then(x => parse_updates(x));
				}

				var update_tmr = setInterval(get_updates, 500);

				// window.paint_elements = paint_elements;
				points[0].insert_point(document.getElementById("Map"));
			// })();
		</script>
	</body>
</html>