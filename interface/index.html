<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Demo</title>

		<style type="text/css">
			html, body {
				background-color: #282828;
				margin: 0;
				padding: 0;
			}
		</style>
	</head>
	<body>
		<style type="text/css">
			.map-viewport {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
				-webkit-user-select: none;
				user-select: none;
			}

			.map-viewport .map-whole {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}

			.map-whole .x-axis,
			.map-whole .y-axis {
				left: 0;
				bottom: 0;
				position: absolute;
				border: 2px dashed #444;
				font-size: 0;
			}

			.map-whole .x-axis {
				/* top: calc(50% - 1px); */
				width: 100%;
				height: 0;
				background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' stroke='black' stroke-width='10' stroke-dasharray='5 20' stroke-dashoffset='0' stroke-linecap='butt'/%3e%3c/svg%3e");
			}

			.map-whole .y-axis {
				/* left: calc(50% - 1px); */
				width: 0;
				height: 100%;
				background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' stroke='black' stroke-width='10' stroke-dasharray='5 20' stroke-dashoffset='0' stroke-linecap='butt'/%3e%3c/svg%3e");
			}

			.map-viewport .anchor-centre,
			.map-viewport .point {
				position: absolute;
				left: 0;
				bottom: 0;
				width: 10px;
				height: 10px;
				border-radius: 5px;
				background-color: #e5e5e5;
				will-change: transform, opacity;
			}

			.map-viewport .inactive {
				opacity: 0.5;
			}

			.map-viewport .hidden {
				display: none;
			}

			.map-viewport .ring {
				left: 0;
				bottom: 0;
				position: absolute;
				border-radius: 100%;
				border: 4px dotted #e5e5e5;
				transform-origin: center;
				will-change: transform, opacity;
			}
		</style>
		<main class="map-viewport">
			<div id="Map" class="map-whole"></div>
		</main>
		<script type="text/javascript">
			// (function(){
				var map_width  = 1;
				var map_height = 1;

				var viewport_scale_x  = 10.0;
				var viewport_scale_y  = 10.0;
				var viewport_offset_x = 0;
				var viewport_offset_y = 0;

				var viewport_padding_x = 20;
				var viewport_padding_y = 20;

				// var viewport_width  = 1;
				// var viewport_height = 1;
				// var viewport_x      = 0;
				// var viewport_y      = 0;

				// var actual_x        = 0;
				// var actual_y        = 0;

				var estimated_x     = 0;
				var estimated_y     = 0;

				var map = document.getElementById("Map");
				var axes = {
					x: document.createElement("div"),
					y: document.createElement("div")
				};

				function Anchor(id, x, y) {
					this.id = id;
					this.x  = x;
					this.y  = y;

					this.radius = null;

					this.element = document.createElement('div');
					this.element.classList.add("anchor-centre");

					this.circle_element = document.createElement("div");
					this.circle_element.classList.add("ring");

					this.is_active = true;

					this.update_element();
				}

				Anchor.prototype.update_element = function() {
					if (this.is_active || this.radius == null) {
						this.element.classList.remove("inactive");
						this.circle_element.classList.remove("inactive");
					} else {
						this.element.classList.add("inactive");
						this.circle_element.classList.add("inactive");
					}

					// if (this.radius == null) {
					// 	this.circle_element.classList.add("hidden");
					// 	return;
					// }

					// this.circle_element.classList.remove("hidden");

					this.circle_element.style.width = (2 * this.radius * viewport_scale_x) + "px";
					this.circle_element.style.height = (2 * this.radius * viewport_scale_y) + "px";

					var bound_box = this.element.getBoundingClientRect();
					var circle_box = this.circle_element.getBoundingClientRect();

					this.element.style.left = ((this.x * viewport_scale_x) - bound_box.width / 2 + viewport_offset_x) + "px";
					this.element.style.bottom = ((this.y * viewport_scale_y) - bound_box.height / 2 + viewport_offset_y) + "px";
					this.circle_element.style.left = ((this.x * viewport_scale_x) - circle_box.width / 2 + viewport_offset_x) + "px";
					this.circle_element.style.bottom = ((this.y * viewport_scale_y) - circle_box.height / 2 + viewport_offset_y) + "px";
				};

				Anchor.prototype.set_coord = function(x, y) {
					this.x = x;
					this.y = y;
				};

				Anchor.prototype.set_radius = function(x, y) {
					this.radius = x;
				};

				Anchor.prototype.insert_point = function(to_insert_into) {
					to_insert_into.appendChild(this.element);
					to_insert_into.appendChild(this.circle_element);
					this.update_element();
				};

				function Point(id, x, y) {
					this.id = id;
					this.x  = x;
					this.y  = y;

					this.element = document.createElement('div');
					this.element.classList.add("point");

					this.is_active = true;
				}

				Point.prototype.update_element = function() {
					if (this.is_active) {
						this.element.classList.remove("inactive");
					} else {
						this.element.classList.add("inactive");
					}

					var bound_box = this.element.getBoundingClientRect();

					this.element.style.left = (this.x * viewport_scale_x - bound_box.width / 2 + viewport_offset_x) + "px";
					this.element.style.bottom = (this.y * viewport_scale_y - bound_box.height / 2 + viewport_offset_y) + "px";
				};

				Point.prototype.set_coord = function(x, y) {
					this.x = x;
					this.y = y;
				};

				Point.prototype.insert_point = function(to_insert_into) {
					to_insert_into.appendChild(this.element);
					this.update_element();
				};

				var anchors = {};

				var points = {
					0: new Point(0, 25, 12)
				};

				function paint_elements() {
					for (var anchor_id in anchors) {
						anchors[anchor_id].update_element();
					}

					for (var point_id in points) {
						points[point_id].update_element();
					}

					update_axes();
				}

				function parse_updates(json_update) {
					// upd_obj = JSON.parse(json_update);
					upd_obj = json_update;

					for (let antenna_id in anchors) {
						anchors[antenna_id].is_active = false;
					}

					for (let antenna_id in upd_obj.antennas) {
						let updated_info = upd_obj.antennas[antenna_id];

						if (anchors.hasOwnProperty(antenna_id)) {
							anchors[antenna_id].set_coord(updated_info.x, updated_info.y);
							anchors[antenna_id].set_radius(updated_info.r);
							anchors[antenna_id].is_active = true;
							// anchors[antenna_id].update_element();
							continue;
						}

						anchors[antenna_id] = new Anchor(antenna_id, updated_info.x, updated_info.y);
						anchors[antenna_id].set_radius(updated_info.r);
						anchors[antenna_id].insert_point(map);
					}

					for (let point_id in points) {
						points[point_id].is_active = false;
					}

					for (let point_id in upd_obj.estimated_sources) {
						let updated_info = upd_obj.estimated_sources[point_id];

						if (points.hasOwnProperty(point_id)) {
							points[point_id].set_coord(updated_info.x, updated_info.y);
							points[point_id].is_active = true;
							// points[point_id].update_element();
							continue;
						}

						points[point_id] = new Point(point_id, updated_info.x, updated_info.y);
						points[point_id].insert_point(map);
					}

					paint_elements();
				}
				// window.parse_updates = parse_updates;

				function get_updates() {
					fetch("upd.json").then(x => x.json()).then(x => parse_updates(x));
				}

				var wsocket = null;
				var socket_active = false;

				function sock_start(event) {
					socket_active = true;
				}

				function sock_receive_updates(event) {
					parse_updates(JSON.parse(event.data));
				}

				function sock_stopped(event) {
					socket_active = false;
				}

				function attempt_new_socket() {
					if (!socket_active) {
						wsocket = new WebSocket("upd.json");
						wsocket.onopen = sock_start;
						wsocket.onclose = sock_stopped;
						wsocket.onerror = sock_stopped;
						wsocket.onmessage = sock_receive_updates;
					}
				}

				function setup_axes() {
					var x_axis = document.createElement('div');
					x_axis.classList.add("x-axis");
					map.appendChild(x_axis);

					var y_axis = document.createElement('div');
					y_axis.classList.add("y-axis");
					map.appendChild(y_axis);

					return {x: x_axis, y: y_axis};
				}

				function update_axes() {
					axes.x.style.transform = "translateY(" + (-viewport_offset_y) + "px)";
					axes.y.style.transform = "translateX(" + (viewport_offset_x) + "px)";
				}

				// var update_tmr = setInterval(get_updates, 500);
				var update_tmr = setInterval(attempt_new_socket, 5000);
				attempt_new_socket();

				// window.paint_elements = paint_elements;
				axes = setup_axes();
				points[0].is_active = false;
				points[0].insert_point(document.getElementById("Map"));
			// })();
		</script>
	</body>
</html>
